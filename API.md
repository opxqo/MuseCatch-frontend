# MuseCatch Backend

<p align="center">
  <strong>ğŸµ åŸºäº Telegram Bot çš„æ— æŸéŸ³ä¹ä¸‹è½½å™¨åç«¯æœåŠ¡</strong>
</p>

<p align="center">
  <a href="#ç‰¹æ€§">ç‰¹æ€§</a> â€¢
  <a href="#æ¶æ„">æ¶æ„</a> â€¢
  <a href="#å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a> â€¢
  <a href="#api-æ–‡æ¡£">API æ–‡æ¡£</a>
</p>

---

## é¡¹ç›®ç®€ä»‹

MuseCatch æ˜¯ä¸€ä¸ªè‡ªæ‰˜ç®¡çš„éŸ³ä¹ä¸‹è½½è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ Telegram éŸ³ä¹æœºå™¨äººæœç´¢å’Œä¸‹è½½æ­Œæ›²ã€‚æœ¬é¡¹ç›®ä¸ºåç«¯ API æœåŠ¡ï¼Œé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæä¾› RESTful API ä¾›å‰ç«¯è°ƒç”¨ã€‚

### å·¥ä½œåŸç†

```
ç”¨æˆ·è¯·æ±‚ â†’ MuseCatch API â†’ Telegram Bot â†’ éŸ³ä¹å¹³å° â†’ ä¸‹è½½æ–‡ä»¶ â†’ WebDAV äº‘å­˜å‚¨
```

1. ç”¨æˆ·é€šè¿‡å‰ç«¯æˆ– API æäº¤æ­Œæ›²åç§°
2. åç«¯å‘ Telegram éŸ³ä¹æœºå™¨äººå‘é€æœç´¢è¯·æ±‚
3. æœºå™¨äººä»å„å¤§éŸ³ä¹å¹³å°è·å–æ— æŸéŸ³æº
4. è‡ªåŠ¨ä¸‹è½½å¹¶ä¸Šä¼ åˆ° WebDAV äº‘å­˜å‚¨
5. å…ƒæ•°æ®å­˜å…¥ MySQL æ•°æ®åº“ä¾›ç®¡ç†

---

## ç‰¹æ€§

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ğŸ” **å¤šå¹³å°æœç´¢** | æ”¯æŒ QQéŸ³ä¹ã€é…·ç‹—ã€é…·æˆ‘ã€ç½‘æ˜“äº‘ç­‰å¹³å° |
| ğŸ“¥ **æ— æŸä¸‹è½½** | è‡ªåŠ¨è·å–æœ€é«˜éŸ³è´¨ (FLAC/MP3) |
| â˜ï¸ **äº‘ç«¯åŒæ­¥** | è‡ªåŠ¨ä¸Šä¼ åˆ° WebDAV (åšæœäº‘ã€NextCloudã€123äº‘ç›˜ç­‰) |
| ğŸ“‹ **é˜Ÿåˆ—ç®¡ç†** | æ‰¹é‡ä¸‹è½½ã€ä¼˜å…ˆçº§æ§åˆ¶ã€å¤±è´¥é‡è¯• |
| ğŸ—„ï¸ **æ­Œæ›²åº“** | MySQL æ•°æ®åº“ç®¡ç†ä¸‹è½½å†å² |
| ğŸ”„ **å®æ—¶è¿›åº¦** | SSE æ¨é€ä¸‹è½½è¿›åº¦ |
| ğŸ³ **å®¹å™¨åŒ–** | Docker ä¸€é”®éƒ¨ç½² |
| ğŸŒ **RESTful API** | æ ‡å‡†åŒ–æ¥å£ï¼Œå‰åç«¯åˆ†ç¦» |

---

## æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (React)                      â”‚
â”‚                   musecatch-frontend (å¼€å‘ä¸­)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP/SSE
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MuseCatch Backend API                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Tasks  â”‚  â”‚  Queue  â”‚  â”‚  Songs  â”‚  â”‚  WebDAV Sync    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚            â”‚            â”‚                 â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      Core Modules                        â”‚ â”‚
â”‚  â”‚  Downloader  â”‚  Uploader  â”‚  Database  â”‚  Config        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Telegram â”‚        â”‚  WebDAV  â”‚         â”‚  MySQL   â”‚
   â”‚   Bot    â”‚        â”‚  Server  â”‚         â”‚ Database â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: FastAPI + Uvicorn
- **Telegram**: Telethon (MTProto)
- **æ•°æ®åº“**: SQLAlchemy + aiomysql (å¼‚æ­¥ MySQL)
- **äº‘å­˜å‚¨**: webdavclient3
- **å®æ—¶é€šä¿¡**: SSE (Server-Sent Events)

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.10+
- MySQL 8.0+
- Telegram API å‡­æ® ([è·å–æ–¹å¼](https://my.telegram.org))

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/opxqo/musecatch-backend.git
cd musecatch-backend

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥é…ç½®

# å¯åŠ¨æœåŠ¡
uvicorn app:app --host 0.0.0.0 --port 8890
```

### Docker éƒ¨ç½²

```bash
docker build -t musecatch-backend .
docker run -d \
  -p 8890:8000 \
  -v ./downloads:/app/downloads \
  -v ./data:/app/data \
  --env-file .env \
  musecatch-backend
```

### ç¯å¢ƒå˜é‡

| å˜é‡ | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `API_ID` | âœ… | Telegram API ID |
| `API_HASH` | âœ… | Telegram API Hash |
| `MYSQL_HOST` | âœ… | æ•°æ®åº“åœ°å€ |
| `MYSQL_PORT` | âœ… | æ•°æ®åº“ç«¯å£ |
| `MYSQL_USER` | âœ… | æ•°æ®åº“ç”¨æˆ· |
| `MYSQL_PASSWORD` | âœ… | æ•°æ®åº“å¯†ç  |
| `MYSQL_DATABASE` | âœ… | æ•°æ®åº“åç§° |
| `WEBDAV_URL` | âŒ | WebDAV æœåŠ¡åœ°å€ |
| `WEBDAV_USERNAME` | âŒ | WebDAV ç”¨æˆ·å |
| `WEBDAV_PASSWORD` | âŒ | WebDAV å¯†ç  |
| `PROXY_TYPE` | âŒ | ä»£ç†ç±»å‹ (socks5/http) |
| `PROXY_HOST` | âŒ | ä»£ç†åœ°å€ |
| `PROXY_PORT` | âŒ | ä»£ç†ç«¯å£ |

---

## API æ–‡æ¡£

**Base URL**: `/api/v1`  
**ç‰ˆæœ¬**: 2.0.0

---

## é€šç”¨è¯´æ˜

### å“åº”æ ¼å¼

æ‰€æœ‰ API å“åº”é‡‡ç”¨ç»Ÿä¸€çš„ JSON æ ¼å¼ï¼š

```json
{
  "code": 0,
  "message": "success",
  "data": { ... }
}
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `code` | int | çŠ¶æ€ç ï¼Œ0 è¡¨ç¤ºæˆåŠŸï¼Œé 0 è¡¨ç¤ºé”™è¯¯ |
| `message` | string | çŠ¶æ€æè¿° |
| `data` | object/null | å“åº”æ•°æ® |

### é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| 0 | æˆåŠŸ |
| 40001 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 40401 | èµ„æºä¸å­˜åœ¨ |
| 50001 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## ç³»ç»Ÿæ¥å£

### å¥åº·æ£€æŸ¥

æ£€æŸ¥ç³»ç»Ÿå„ç»„ä»¶è¿è¡ŒçŠ¶æ€ã€‚

```
GET /api/v1/health
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "status": "ok",
    "telegram_connected": true,
    "webdav_enabled": true,
    "queue_worker_running": true
  }
}
```

---

## æ–‡ä»¶ç®¡ç† (Files)

### è·å–å·²ä¸‹è½½æ–‡ä»¶åˆ—è¡¨

```
GET /api/v1/files
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "name": "ä¸ƒé‡Œé¦™_-_å‘¨æ°ä¼¦_-_QQ.mp3",
        "size": 10485760,
        "url": "/downloads/ä¸ƒé‡Œé¦™_-_å‘¨æ°ä¼¦_-_QQ.mp3"
      }
    ],
    "count": 1
  }
}
```

### åˆ é™¤æ–‡ä»¶

```
DELETE /api/v1/files/{filename}
```

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| filename | string | æ˜¯ | æ–‡ä»¶å (éœ€ URL ç¼–ç ) |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "å·²åˆ é™¤: ä¸ƒé‡Œé¦™_-_å‘¨æ°ä¼¦_-_QQ.mp3",
  "data": null
}
```

### è·å–æœç´¢æºåˆ—è¡¨

```
GET /api/v1/files/sources
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      { "key": "qq", "name": "QQéŸ³ä¹" },
      { "key": "kugou", "name": "é…·ç‹—éŸ³ä¹" },
      { "key": "kuwo", "name": "é…·æˆ‘éŸ³ä¹" },
      { "key": "netease", "name": "ç½‘æ˜“äº‘éŸ³ä¹" }
    ]
  }
}
```

---

## ä¸‹è½½ä»»åŠ¡ (Tasks)

### åˆ›å»ºä¸‹è½½ä»»åŠ¡

```
POST /api/v1/tasks
```

**è¯·æ±‚ä½“**:
```json
{
  "song_name": "ä¸ƒé‡Œé¦™",
  "source": "qq"
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| song_name | string | æ˜¯ | æ­Œæ›²åç§° |
| source | string | å¦ | æœç´¢æº (qq/kugou/kuwo/netease)ï¼Œä¸ä¼ åˆ™è‡ªåŠ¨å°è¯•æ‰€æœ‰æº |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "task_id": "a1b2c3d4",
    "song_name": "ä¸ƒé‡Œé¦™"
  }
}
```

### è·å–ä»»åŠ¡è¿›åº¦ (SSE)

ä½¿ç”¨ Server-Sent Events å®æ—¶è·å–ä¸‹è½½è¿›åº¦ã€‚

```
GET /api/v1/tasks/{task_id}/progress
```

**äº‹ä»¶æ ¼å¼**:
```
event: progress
data: {"percent": 50.0, "status": "ä¸‹è½½ä¸­ 50%", "complete": false, "result": null}
```

**å®Œæˆäº‹ä»¶**:
```
event: progress
data: {"percent": 100, "status": "å®Œæˆ", "complete": true, "result": {"success": true, "filename": "..."}}
```

### åˆ›å»ºæ‰¹é‡ä¸‹è½½ä»»åŠ¡

```
POST /api/v1/tasks/batch
```

**è¯·æ±‚ä½“**:
```json
{
  "songs": ["ä¸ƒé‡Œé¦™", "æ±Ÿå—", "åå¹´"],
  "source": null,
  "interval": 60
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| songs | string[] | æ˜¯ | æ­Œæ›²åç§°åˆ—è¡¨ |
| source | string | å¦ | æœç´¢æº |
| interval | int | å¦ | æ¯é¦–æ­Œä¸‹è½½é—´éš” (ç§’)ï¼Œé»˜è®¤ 60 |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "batch_id": "b1c2d3e4",
    "total": 3,
    "interval": 60
  }
}
```

### è·å–æ‰¹é‡ä»»åŠ¡è¿›åº¦

```
GET /api/v1/tasks/{batch_id}/batch-progress
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "batch_id": "b1c2d3e4",
    "total": 3,
    "current": 2,
    "current_song": "æ±Ÿå—",
    "status": "æ­£åœ¨ä¸‹è½½ (2/3): æ±Ÿå—",
    "results": [
      { "song": "ä¸ƒé‡Œé¦™", "success": true, "filename": "..." }
    ],
    "complete": false
  }
}
```

### å–æ¶ˆæ‰¹é‡ä»»åŠ¡

```
DELETE /api/v1/tasks/{batch_id}
```

---

## ä¸‹è½½é˜Ÿåˆ— (Queue)

### è·å–é˜Ÿåˆ—åˆ—è¡¨

```
GET /api/v1/queue
```

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| status | string | å¦ | æŒ‰çŠ¶æ€ç­›é€‰ (pending/downloading/completed/failed) |
| limit | int | å¦ | è¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤ 50 |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "song_name": "ä¸ƒé‡Œé¦™",
        "source": "qq",
        "status": "pending",
        "priority": 0,
        "error_message": null,
        "created_at": "2026-01-31T15:00:00"
      }
    ]
  }
}
```

### æ·»åŠ åˆ°é˜Ÿåˆ—

æ”¯æŒå•é¦–æˆ–æ‰¹é‡æ·»åŠ ã€‚

```
POST /api/v1/queue
```

**è¯·æ±‚ä½“**:
```json
{
  "songs": ["ä¸ƒé‡Œé¦™", "æ±Ÿå—"],
  "source": null,
  "priority": 0
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| songs | string[] | æ˜¯ | æ­Œæ›²åç§°åˆ—è¡¨ |
| source | string | å¦ | æœç´¢æº |
| priority | int | å¦ | ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå¤§è¶Šä¼˜å…ˆï¼Œé»˜è®¤ 0 |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "count": 2,
    "songs": ["ä¸ƒé‡Œé¦™", "æ±Ÿå—"]
  }
}
```

### è·å–é˜Ÿåˆ—ç»Ÿè®¡

```
GET /api/v1/queue/stats
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "pending": 5,
    "downloading": 1,
    "completed": 10,
    "failed": 2,
    "total": 18
  }
}
```

### ä»é˜Ÿåˆ—åˆ é™¤

```
DELETE /api/v1/queue/{id}
```

---

## æ­Œæ›²åº“ (Songs)

### è·å–æ­Œæ›²åˆ—è¡¨

```
GET /api/v1/songs
```

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| skip | int | å¦ | è·³è¿‡æ¡æ•°ï¼Œç”¨äºåˆ†é¡µï¼Œé»˜è®¤ 0 |
| limit | int | å¦ | è¿”å›æ•°é‡ï¼Œé»˜è®¤ 50 |
| source | string | å¦ | æŒ‰æ¥æºç­›é€‰ |
| search | string | å¦ | æŒ‰æ­Œåæœç´¢ |

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "title": "ä¸ƒé‡Œé¦™",
        "artist_id": 1,
        "source": "qq",
        "filename": "ä¸ƒé‡Œé¦™_-_å‘¨æ°ä¼¦_-_QQ.mp3",
        "file_size": 10485760,
        "file_ext": ".mp3",
        "webdav_uploaded": true,
        "created_at": "2026-01-31T15:00:00"
      }
    ],
    "skip": 0,
    "limit": 50
  }
}
```

### è·å–æ­Œæ›²ç»Ÿè®¡

```
GET /api/v1/songs/stats
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total": 100,
    "uploaded": 95,
    "by_source": {
      "qq": 40,
      "kugou": 30,
      "kuwo": 20,
      "netease": 10
    }
  }
}
```

---

## WebDAV åŒæ­¥ (WebDAV)

### è·å– WebDAV æ–‡ä»¶åˆ—è¡¨

```
GET /api/v1/webdav/files
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "filename": "ä¸ƒé‡Œé¦™_-_å‘¨æ°ä¼¦_-_QQ.mp3",
        "remote_path": "/webdav/ä¸ƒé‡Œé¦™_-_å‘¨æ°ä¼¦_-_QQ.mp3",
        "size": 10485760,
        "modified": "2026-01-31T15:00:00"
      }
    ],
    "count": 100
  }
}
```

### åŒæ­¥ WebDAV åˆ°æ•°æ®åº“

æ‰«æ WebDAV ä¸Šçš„æ–‡ä»¶å¹¶å¯¼å…¥åˆ°æ•°æ®åº“ã€‚

```
POST /api/v1/webdav/sync
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "imported": 10,
    "skipped": 90,
    "total": 100
  }
}
```

---

## Swagger UI

è®¿é—® `/docs` å¯æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„äº¤äº’å¼ API æ–‡æ¡£ã€‚

```
http://localhost:8890/docs
```
